# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is **sparkinai-admin**, a Vue 3 admin dashboard built with TypeScript, Element Plus, and Vite. 

## Development Commands

### Package Manager
This project uses **pnpm** exclusively. The `preinstall` script enforces this.

```bash
# Install dependencies
pnpm install

# Development server (runs on port from .env, opens browser automatically)
pnpm dev

# Build for production (includes type checking)
pnpm build

# Build without type checking
pnpm build-only

# Type checking only
pnpm type-check

# Preview production build
pnpm preview
```

### Linting & Formatting

```bash
# Lint and fix TypeScript/Vue files
pnpm lint:eslint

# Format all files with Prettier
pnpm lint:prettier

# Lint and fix styles
pnpm lint:stylelint

# Run lint-staged (used by Husky pre-commit)
pnpm lint:lint-staged
```

### Git Commits

```bash
# Interactive commit with commitizen
pnpm commit
```

The project uses Husky for Git hooks and follows conventional commit standards via commitizen/cz-git.

## Architecture

### Core Technology Stack
- **Vue 3.5** with Composition API and `<script setup>` syntax
- **TypeScript** with relaxed strict mode (see tsconfig.json)
- **Vite 7** for build tooling
- **Element Plus** for UI components (auto-imported)
- **Pinia** for state management
- **Vue Router** with dynamic route generation
- **UnoCSS** for atomic CSS utilities
- **Axios** for HTTP requests with custom interceptors

### Auto-Import Configuration
The project uses `unplugin-auto-import` and `unplugin-vue-components` to automatically import:
- Vue APIs (`ref`, `computed`, `watch`, etc.)
- VueUse composables (`@vueuse/core`)
- Pinia APIs
- Vue Router APIs
- Element Plus components

**Important**: Do not manually import these - they are globally available.

### Project Structure

```
src/
├── api/              # API service layer (auth, user, admin, etc.)
├── assets/           # Static assets (icons, images)
├── components/       # Shared components
├── directives/       # Custom Vue directives (e.g., permission)
├── hooks/            # Composable functions
├── layouts/          # Layout components (Left, Top, Mix, Base)
├── router/           # Route configuration
│   ├── index.ts      # Router setup and static routes
│   └── admin/        # Dynamic route modules (loaded by permission store)
├── store/            # Pinia stores
│   ├── modules/      # Store modules (app, user, permission, settings, tags-view, admin)
│   └── index.ts      # Store setup
├── styles/           # Global styles (SCSS with variables)
├── types/            # TypeScript type definitions
├── utils/            # Utility functions (request, auth, format, etc.)
└── views/            # Page components
```

### State Management (Pinia)

Key stores:
- **user**: Authentication, user info, token management with refresh logic
- **permission**: Dynamic route generation from backend or mock data
- **app**: App-level state (sidebar, device type)
- **settings**: UI settings (layout mode, theme)
- **tags-view**: Tab navigation state
- **admin**: Admin-specific state

### Routing System

The app uses a **hybrid routing approach**:

1. **Static routes** (`constantRoutes` in `src/router/index.ts`):
   - Login, OAuth callback, dashboard, error pages, profile

2. **Dynamic routes** (generated by `permission` store):
   - Loaded from backend API (`UserAPI.getUserMenusApi()`)
   - Falls back to mock routes from `src/router/admin/*.ts` if API fails
   - Can be forced to use mock routes via `VITE_USE_MOCK_MENU=true`

**Route generation flow**:
- `permission.generateRoutes()` fetches user menus
- Transforms menu data to `RouteRecordRaw` objects
- Matches `component` strings to actual Vue components via `import.meta.glob`
- Adds routes dynamically to router instance

**Layout components**:
- Routes use `Layout` component (from `src/layouts/index.vue`)
- Supports multiple layout modes: Left, Top, Mix, Base

### HTTP Request Layer

**File**: `src/utils/request.ts`

Key features:
- Custom headers: `App-Name`, `Timestamp`, `X-Terminal-Id`, `X-Terminal-Token`, `Uid`, `Authorization`
- Terminal signature using MD5 hash
- Automatic token refresh on 402 response code
- Request queue during token refresh to prevent duplicate refresh calls
- Response code handling: 200 (success), 400 (bad request), 401 (unauthorized), 402 (token expired), 403 (forbidden)

**Authentication flow**:
- Access token stored via `AuthStorage` (in `src/utils/auth.ts`)
- On 402 response, triggers `useUserStoreHook().refreshToken()`
- Queues pending requests during refresh
- Retries all queued requests after successful refresh
- Redirects to login on refresh failure

### Environment Configuration

**Development** (`.env.development`):
- API proxy: `/admin-api` → `http://localhost:9091`
- Mock server enabled by default
- WebSocket: `ws://localhost:9091/admin-api/v1/websocket`

**Production** (`.env.production`):
- API: `https://admin.veweiyi.cn`
- Mock disabled
- WebSocket: `wss://admin.veweiyi.cn/admin-api/v1/websocket`

### Mock Server

**Directory**: `mock/`

Uses `vite-plugin-mock-dev-server` for development mocking. Mock files include:
- `auth.mock.ts`: Login, logout, token refresh
- `user.mock.ts`: User info, menus
- `admin.mock.ts`: Admin operations
- `dashboard.mock.ts`: Dashboard data
- `upload.mock.ts`: File upload simulation

Enable/disable via `VITE_MOCK_DEV_SERVER` in `.env.development`.

### Permission System

**Custom directive**: `v-permission` (in `src/directives/permission/`)

Controls element visibility based on user permissions. Used for button-level access control.

### Styling

- **SCSS**: Global variables in `src/styles/variables.scss`, auto-imported in all SCSS files
- **UnoCSS**: Atomic utilities with custom shortcuts (e.g., `flex-center`, `wh-full`)
- **Element Plus**: Dark mode support via `element-plus/theme-chalk/dark/css-vars.css`
- **Custom icons**: Local SVG icons in `src/assets/icons/`, accessible via `i-svg:icon-name`

### Build Configuration

**Vite config highlights**:
- Path alias: `@` → `src/`
- Proxy setup for API requests
- Terser minification with console removal in production
- Code splitting with custom chunk naming
- Asset categorization (js, img, fonts, media)

## Common Patterns

### API Service Pattern

API services are organized by domain in `src/api/`:

```typescript
// Example: src/api/user.ts
import request from "@/utils/request";
import type { ApiResponse, UserInfo } from "./types";

export const UserAPI = {
  getUserInfo(): Promise<ApiResponse<UserInfo>> {
    return request({
      url: "/admin-api/v1/user/info",
      method: "get",
    });
  },
};
```

### Store Pattern

Stores use Composition API style:

```typescript
export const useMyStore = defineStore("myStore", () => {
  const state = ref<MyState>({});

  function myAction() {
    // action logic
  }

  return { state, myAction };
});

// For use outside components
export function useMyStoreHook() {
  return useMyStore(store);
}
```

### Component Auto-Registration

Components in `src/components/` and `src/**/components/` are auto-registered. Use PascalCase names directly in templates.

## Important Notes

- **Node version**: Requires Node.js >= 18.0.0 (see `engines` in package.json)
- **TypeScript**: Strict mode is enabled but many strict checks are disabled (see tsconfig.json)
- **Router mode**: Uses `createWebHistory()` (not hash mode) for OAuth callback compatibility
- **WebSocket**: Optional WebSocket endpoint configured via `VITE_APP_WS_ENDPOINT`
- **Third-party editors**: Includes WangEditor (`@wangeditor-next/editor`) and Markdown editor (`md-editor-v3`)
- **Charts**: ECharts 5.6.0 with tree-shaking support
- **Drag & Drop**: Uses `vue-draggable-plus` and `sortablejs`
